import { drizzle } from "drizzle-orm/node-postgres";
import pg from "pg";
import { randomUUID } from "crypto";
import { newDb, DataType } from "pg-mem";
import * as schema from "@shared/schema";
import { MEMORY_SCHEMA_SQL } from "./memory-schema";

const { Pool } = pg;

const USE_MEMORY_DB =
  process.env.LOGGING_USE_MEMORY_DB === "true" || !process.env.DATABASE_URL;

let pool: pg.Pool;

function wrapPgMemPool(pool: pg.Pool): pg.Pool {
  const originalQuery = pool.query.bind(pool);
  pool.query = ((query: any, ...args: any[]) => {
    if (query && typeof query === "object") {
      const wantsArray = query.rowMode === "array";
      const sanitized = { ...query };
      delete sanitized.types;
      delete sanitized.rowMode;
      return Promise.resolve(originalQuery(sanitized, ...args)).then((result: any) => {
        if (wantsArray && result && Array.isArray(result.rows)) {
          const names =
            Array.isArray(result.fields) && result.fields.length > 0
              ? result.fields.map((field: any) => field.name)
              : null;
          result.rows = result.rows.map((row: any) =>
            names ? names.map((name: string) => row?.[name]) : Object.values(row)
          );
        }
        return result;
      });
    }
    return originalQuery(query, ...args);
  }) as typeof pool.query;
  return pool;
}

if (USE_MEMORY_DB) {
  const mem = newDb({ autoCreateForeignKeyIndices: true });

  mem.public.registerFunction({
    name: "gen_random_uuid",
    returns: DataType.uuid,
    impure: true,
    implementation: () => randomUUID(),
  });
  mem.public.registerFunction({
    name: "uuid_generate_v4",
    returns: DataType.uuid,
    impure: true,
    implementation: () => randomUUID(),
  });
  mem.public.registerFunction({
    name: "now",
    returns: DataType.timestamptz,
    impure: true,
    implementation: () => new Date(),
  });

  mem.public.none(MEMORY_SCHEMA_SQL);

  const adapter = mem.adapters.createPg();
  pool = wrapPgMemPool(new adapter.Pool());
  console.log("[DB] Using in-memory database (pg-mem).");
} else {
  pool = new Pool({ connectionString: process.env.DATABASE_URL });
}

export const db = drizzle(pool, { schema });
export { pool };
