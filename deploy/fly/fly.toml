# Fly.io Configuration Template
#
# For Fly.io UI deployment:
# 1. Create app in Fly.io dashboard
# 2. Set build arg: SERVICE=identity (or catalog, models, etc.)
# 3. Deploy from GitHub repo
#
# Or via CLI:
#   flyctl launch --dockerfile Dockerfile
#   flyctl deploy --build-arg SERVICE=identity

app = "symbia-identity"
primary_region = "iad"

[build]
  dockerfile = "Dockerfile"
  [build.args]
    SERVICE = "identity"

[env]
  NODE_ENV = "production"
  PORT = "5001"
  HOST = "0.0.0.0"
  # Use in-memory database for simple deployments (no PostgreSQL needed)
  # Set to "false" and provide DATABASE_URL secret for persistent storage
  IDENTITY_USE_MEMORY_DB = "true"
  # Internal service URLs (Fly.io private networking)
  IDENTITY_SERVICE_URL = "http://symbia-identity.internal:5001"
  LOGGING_SERVICE_URL = "http://symbia-logging.internal:5002"
  CATALOG_SERVICE_URL = "http://symbia-catalog.internal:5003"
  ASSISTANTS_SERVICE_URL = "http://symbia-assistants.internal:5004"
  MESSAGING_SERVICE_URL = "http://symbia-messaging.internal:5005"
  RUNTIME_SERVICE_URL = "http://symbia-runtime.internal:5006"
  INTEGRATIONS_SERVICE_URL = "http://symbia-integrations.internal:5007"
  MODELS_SERVICE_URL = "http://symbia-models.internal:5008"
  NETWORK_SERVICE_URL = "http://symbia-network.internal:5054"

# REQUIRED secrets (set via: flyctl secrets set KEY=value)
# SESSION_SECRET - Required for JWT signing (min 32 chars)
#   flyctl secrets set SESSION_SECRET=your-secure-secret-min-32-chars
#
# OPTIONAL secrets:
# DATABASE_URL - For persistent PostgreSQL storage (disable IDENTITY_USE_MEMORY_DB)
#   flyctl secrets set DATABASE_URL=postgres://user:pass@host:5432/db

[http_service]
  internal_port = 5001
  force_https = true
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1

[[services]]
  protocol = "tcp"
  internal_port = 5001

  [[services.ports]]
    port = 443
    handlers = ["tls", "http"]

  [[services.http_checks]]
    interval = "15s"
    timeout = "5s"
    grace_period = "30s"
    path = "/health/live"

[[vm]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 512
