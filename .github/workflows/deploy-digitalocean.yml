name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: registry.digitalocean.com
  REGISTRY_NAME: symbia

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="sha-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Login to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push service images
        env:
          IMAGE_TAG: ${{ steps.meta.outputs.tag }}
        run: |
          SERVICES=(identity logging catalog assistants messaging runtime integrations network models)

          for service in "${SERVICES[@]}"; do
            echo "=== Building $service ==="

            # Build using root Dockerfile with SERVICE build arg
            docker build -t "$REGISTRY/$REGISTRY_NAME/$service:$IMAGE_TAG" \
                         -t "$REGISTRY/$REGISTRY_NAME/$service:latest" \
                         --build-arg SERVICE="$service" \
                         -f Dockerfile .

            docker push "$REGISTRY/$REGISTRY_NAME/$service:$IMAGE_TAG"
            docker push "$REGISTRY/$REGISTRY_NAME/$service:latest"
          done

  deploy-app-platform:
    name: Deploy to App Platform
    needs: build-and-push
    runs-on: ubuntu-latest
    if: vars.DEPLOY_TARGET == 'app-platform'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Update App Platform
        run: |
          # Update the app spec with new image tag
          sed -i "s/:latest/:${{ needs.build-and-push.outputs.image_tag }}/g" deploy/digitalocean/app-spec.yaml

          # Update or create app
          if [ -n "${{ secrets.DIGITALOCEAN_APP_ID }}" ]; then
            doctl apps update ${{ secrets.DIGITALOCEAN_APP_ID }} --spec deploy/digitalocean/app-spec.yaml
          else
            doctl apps create --spec deploy/digitalocean/app-spec.yaml
          fi

  deploy-droplet:
    name: Deploy to Droplet
    needs: build-and-push
    runs-on: ubuntu-latest
    if: vars.DEPLOY_TARGET == 'droplet'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DROPLET_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Droplet
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'ENDSSH'
            cd /opt/symbia

            # Login to DO registry
            doctl registry login --expiry-seconds 600

            # Update image tag
            sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=${{ env.IMAGE_TAG }}/" .env

            # Pull and restart
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d

            # Cleanup
            docker image prune -f
          ENDSSH

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} \
            'curl -sf http://localhost:5001/health/live'
