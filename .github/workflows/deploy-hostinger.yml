name: Deploy to Hostinger VPS

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="sha-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Image tag: $TAG"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push all services
        env:
          IMAGE_TAG: ${{ steps.meta.outputs.tag }}
        run: |
          SERVICES=(identity logging catalog assistants messaging runtime integrations network models)

          for service in "${SERVICES[@]}"; do
            echo "=== Building $service ==="

            # Build using root Dockerfile with SERVICE build arg
            docker build -t "$REGISTRY/$IMAGE_PREFIX/$service:$IMAGE_TAG" \
                         -t "$REGISTRY/$IMAGE_PREFIX/$service:latest" \
                         --build-arg SERVICE="$service" \
                         -f Dockerfile .

            docker push "$REGISTRY/$IMAGE_PREFIX/$service:$IMAGE_TAG"
            docker push "$REGISTRY/$IMAGE_PREFIX/$service:latest"

            echo "âœ“ $service pushed"
          done

  deploy:
    name: Deploy to VPS
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Copy configuration files
        run: |
          scp -i ~/.ssh/deploy_key \
            deploy/hostinger/docker-compose.prod.yml \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/opt/symbia/

          scp -i ~/.ssh/deploy_key \
            deploy/hostinger/nginx/symbia.conf \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/opt/symbia/nginx/

      - name: Deploy services
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            cd /opt/symbia

            # Update image tag in .env
            sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=${{ env.IMAGE_TAG }}/" .env

            # Update image references to use GHCR
            export IMAGE_TAG="${{ env.IMAGE_TAG }}"

            # Login to GHCR (using deploy token)
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull and restart
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d

            # Wait for health checks
            sleep 15

            # Show status
            docker compose -f docker-compose.prod.yml ps

            # Cleanup
            docker image prune -f
          ENDSSH

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            'curl -sf http://localhost:5001/health/live || exit 1'
          echo "Deployment verified - identity service is healthy"
