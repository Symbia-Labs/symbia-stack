<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Symbia Service Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Symbia Design System Tokens */
      --surface-base: #0d1117;
      --surface-raised: #161b22;
      --surface-overlay: #1c2129;
      --surface-sunken: #080b0f;
      --surface-highlight: #1f2a38;

      --border-default: #30363d;
      --border-muted: #21262d;
      --border-emphasis: #3fb8af;

      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --text-link: #3fb8af;

      --primary-500: #3fb8af;
      --primary-600: #0d9488;
      --primary-700: #0a7c72;

      --success: #3fb950;
      --success-muted: #1a4d3a;
      --warning: #d29922;
      --warning-muted: #4a3d1a;
      --error: #f85149;
      --error-muted: #5c1a1a;
      --info: #58a6ff;

      /* Legacy aliases for compatibility */
      --bg-primary: var(--surface-base);
      --bg-secondary: var(--surface-raised);
      --bg-tertiary: var(--surface-overlay);
      --accent: var(--primary-500);
      --accent-hover: var(--primary-600);
      --border: var(--border-default);

      /* Typography */
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', 'SF Mono', Consolas, monospace;

      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 0 20px rgba(63, 184, 175, 0.15);

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-base: 200ms ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans);
      background: var(--surface-base);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .hidden {
      display: none !important;
    }

    /* Header */
    .header {
      height: 56px;
      background: var(--surface-raised);
      border-bottom: 1px solid var(--border-default);
      padding: 0 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-family: var(--font-mono);
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary-500);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      letter-spacing: -0.01em;
    }

    .header-logo {
      font-size: 1.25rem;
      line-height: 1;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-details {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .avatar {
      width: 28px;
      height: 28px;
      min-width: 28px;
      max-width: 28px;
      min-height: 28px;
      max-height: 28px;
      border-radius: 50%;
      background: var(--primary-500);
      color: var(--surface-base);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.75rem;
      flex: 0 0 28px;
    }

    .user-details .user-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .logout-btn {
      padding: 0.375rem 0.75rem;
      background: var(--surface-highlight);
      border: 1px solid var(--border-default);
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      font-family: var(--font-sans);
      font-size: 0.875rem;
      font-weight: 500;
      transition: all var(--transition-fast);
    }

    .logout-btn:hover {
      background: var(--surface-highlight);
      color: var(--text-primary);
    }

    .logout-btn:active {
      background: var(--surface-sunken);
    }

    /* Main Layout */
    .main-container {
      display: flex;
      height: calc(100vh - 56px);
    }

    /* Sidebar Tabs */
    .sidebar {
      width: 220px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      padding: 1rem 0;
      overflow-y: auto;
    }

    .sidebar-section {
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--text-secondary);
      letter-spacing: 0.05em;
    }

    .service-tab {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: all 0.15s;
      border-left: 3px solid transparent;
    }

    .service-tab:hover {
      background: var(--bg-tertiary);
    }

    .service-tab.active {
      background: var(--surface-overlay);
      border-left-color: var(--primary-500);
      box-shadow: inset 3px 0 8px rgba(63, 184, 175, 0.1);
    }

    .service-tab .status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .service-tab .status.unhealthy {
      background: var(--error);
    }

    .service-tab .name {
      flex: 1;
      font-size: 0.9rem;
    }

    .service-tab .port {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-family: var(--font-mono);
    }

    /* Quick Actions Sidebar Section */
    .sidebar-divider {
      height: 1px;
      background: var(--border-muted);
      margin: 1rem 0;
    }

    .quick-actions {
      padding: 0 0.75rem;
    }

    .quick-action-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.6rem 0.75rem;
      margin-bottom: 0.35rem;
      background: var(--surface-overlay);
      border: 1px solid var(--border-muted);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-family: var(--font-sans);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: left;
    }

    .quick-action-btn:hover {
      background: var(--surface-highlight);
      border-color: var(--primary-500);
      color: var(--text-primary);
    }

    .quick-action-btn:active {
      background: var(--surface-sunken);
    }

    .quick-action-btn.loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .quick-action-btn .icon {
      font-size: 0.9rem;
      width: 1.2rem;
      text-align: center;
    }

    .quick-action-btn .label {
      flex: 1;
    }

    .quick-action-btn .method-badge {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 0.15rem 0.35rem;
      border-radius: 3px;
      font-family: var(--font-mono);
    }

    .quick-action-btn .method-badge.get {
      background: rgba(63, 185, 80, 0.15);
      color: var(--success);
    }

    .quick-action-btn .method-badge.post {
      background: rgba(63, 184, 175, 0.15);
      color: var(--primary-500);
    }

    /* Quick Action Results Panel */
    .quick-results-panel {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 500px;
      max-height: 400px;
      background: var(--surface-raised);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      z-index: 100;
      display: none;
      overflow: hidden;
    }

    .quick-results-panel.active {
      display: flex;
      flex-direction: column;
      animation: slideUp 0.2s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .quick-results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--surface-overlay);
      border-bottom: 1px solid var(--border-muted);
    }

    .quick-results-header .title {
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .quick-results-header .status-badge {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }

    .quick-results-header .status-badge.success {
      background: var(--success-muted);
      color: var(--success);
    }

    .quick-results-header .status-badge.error {
      background: var(--error-muted);
      color: var(--error);
    }

    .quick-results-header .close-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0.25rem;
      font-size: 1.1rem;
      line-height: 1;
    }

    .quick-results-header .close-btn:hover {
      color: var(--text-primary);
    }

    .quick-results-body {
      flex: 1;
      overflow: auto;
      padding: 1rem;
      background: var(--surface-sunken);
      font-family: var(--font-mono);
      font-size: 0.8rem;
      white-space: pre-wrap;
      max-height: 320px;
    }

    /* Content Area */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }

    .service-panel {
      display: none;
    }

    .service-panel.active {
      display: block;
    }

    .panel-header {
      margin-bottom: 2rem;
    }

    .panel-header h2 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
    }

    .panel-header .meta {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Cards */
    .card {
      background: var(--surface-raised);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }

    .card:hover {
      border-color: var(--border-emphasis);
      box-shadow: var(--shadow-glow);
    }

    .card h3 {
      font-size: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Endpoints List */
    .endpoints-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .endpoint-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: var(--bg-tertiary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
      border-left: 3px solid transparent;
    }

    .endpoint-item:hover {
      background: var(--bg-primary);
    }

    .endpoint-item.expanded {
      background: var(--surface-highlight);
      border-left-color: var(--primary-500);
      border-radius: 6px 6px 0 0;
    }

    .endpoint-item .method {
      font-size: 0.7rem;
      font-weight: 700;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      min-width: 60px;
      text-align: center;
    }

    .method.get { background: rgba(63, 185, 80, 0.15); color: var(--success); }
    .method.post { background: rgba(63, 184, 175, 0.15); color: var(--primary-500); }
    .method.put { background: rgba(210, 153, 34, 0.15); color: var(--warning); }
    .method.delete { background: rgba(248, 81, 73, 0.15); color: var(--error); }
    .method.patch { background: rgba(168, 85, 247, 0.15); color: #a855f7; }

    .endpoint-item .path {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      flex: 1;
    }

    .endpoint-item .summary {
      color: var(--text-secondary);
      font-size: 0.85rem;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* API Tester */
    .api-tester {
      display: none;
      margin-top: 0;
      padding: 1.5rem;
      background: var(--surface-highlight);
      border-radius: 0 0 6px 6px;
      border: 1px solid var(--primary-500);
      border-top: none;
      margin-bottom: 0.5rem;
    }

    .api-tester.active {
      display: block;
      animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .tester-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .tester-header .method {
      font-size: 0.8rem;
      font-weight: 700;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
    }

    .tester-header .path {
      font-family: var(--font-mono);
      font-size: 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    input, textarea, select {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
    }

    textarea {
      min-height: 120px;
      font-family: var(--font-mono);
      resize: vertical;
    }

    button {
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }

    button:hover {
      background: var(--accent-hover);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.secondary {
      background: var(--bg-tertiary);
    }

    button.secondary:hover {
      background: var(--border);
    }

    /* Response Panel */
    .response-panel {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 6px;
      display: none;
    }

    .response-panel.active {
      display: block;
    }

    .response-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-size: 0.85rem;
    }

    .response-status .code {
      font-weight: 700;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }

    .response-status .code.success { background: var(--success-muted); color: var(--success); }
    .response-status .code.error { background: var(--error-muted); color: var(--error); }

    .response-body {
      background: var(--surface-base);
      padding: 1rem;
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      white-space: pre-wrap;
      max-height: 400px;
      overflow: auto;
    }

    /* First Run Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: var(--surface-raised);
      border: 1px solid var(--border-default);
      border-radius: 16px;
      padding: 2rem;
      max-width: 480px;
      width: 90%;
      box-shadow: var(--shadow-lg), var(--shadow-glow);
    }

    .modal h2 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .modal p {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }

    .modal .form-group {
      margin-bottom: 1rem;
    }

    .modal .actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.75rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Docs Panel */
    .docs-panel {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .docs-panel h4 {
      margin-bottom: 0.5rem;
    }

    .docs-panel .param {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    .docs-panel .param:last-child {
      border-bottom: none;
    }

    .docs-panel .param-name {
      font-family: var(--font-mono);
      color: var(--primary-500);
    }

    .docs-panel .param-type {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .docs-panel .param-required {
      color: var(--error);
      font-size: 0.75rem;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .empty-state .icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .org-select {
      padding: 0.375rem 2rem 0.375rem 0.75rem;
      border-radius: 6px;
      border: 1px solid var(--border-default);
      background: var(--surface-sunken);
      color: var(--text-primary);
      font-family: var(--font-sans);
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 200px;
      cursor: pointer;
      transition: all var(--transition-fast);
      /* Custom dropdown arrow for better visibility */
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b949e' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 12px;
    }

    .org-select:hover {
      border-color: var(--border-emphasis);
      background-color: var(--surface-highlight);
    }

    .org-select:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 2px rgba(63, 184, 175, 0.2);
    }

    .org-select.hidden {
      display: none;
    }

    .org-select option {
      background: var(--surface-raised);
      color: var(--text-primary);
      padding: 0.5rem;
    }

    /* Enhanced API Documentation */
    .endpoint-docs {
      margin-bottom: 1.5rem;
    }

    .endpoint-docs .endpoint-summary {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-muted);
    }

    .schema-section {
      margin-bottom: 1.25rem;
    }

    .schema-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--primary-500);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .schema-fields {
      background: var(--surface-sunken);
      border: 1px solid var(--border-muted);
      border-radius: 8px;
      overflow: hidden;
    }

    .schema-field {
      display: grid;
      grid-template-columns: 140px 80px 1fr;
      gap: 1rem;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-muted);
      font-size: 0.85rem;
      align-items: start;
    }

    .schema-field:last-child {
      border-bottom: none;
    }

    .schema-field:hover {
      background: var(--surface-base);
    }

    .schema-field-name {
      font-family: var(--font-mono);
      font-weight: 500;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .schema-field-name .required-badge {
      font-size: 0.65rem;
      padding: 0.1rem 0.35rem;
      background: var(--error-muted);
      color: var(--error);
      border-radius: 3px;
      font-weight: 600;
      font-family: var(--font-sans);
    }

    .schema-field-type {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--info);
      background: rgba(88, 166, 255, 0.1);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      text-align: center;
    }

    .schema-field-desc {
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .schema-field-example {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .request-body-section {
      margin-top: 1.25rem;
    }

    .request-body-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .request-body-header label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--primary-500);
    }

    .request-body-actions {
      display: flex;
      gap: 0.5rem;
    }

    .request-body-actions button {
      padding: 0.35rem 0.75rem;
      font-size: 0.75rem;
      background: var(--surface-overlay);
      border: 1px solid var(--border-default);
    }

    .request-body-actions button:hover {
      background: var(--surface-highlight);
      border-color: var(--primary-500);
    }

    textarea.body-editor {
      min-height: 180px;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      line-height: 1.5;
      background: var(--surface-sunken);
      border: 1px solid var(--border-muted);
      padding: 1rem;
    }

    textarea.body-editor:focus {
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(63, 184, 175, 0.15);
    }

    .tester-actions {
      margin-top: 1.25rem;
      display: flex;
      gap: 0.75rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--border-muted);
    }

    .tester-actions button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .response-panel {
      margin-top: 1.25rem;
      padding: 1.25rem;
      background: var(--surface-sunken);
      border: 1px solid var(--border-muted);
      border-radius: 8px;
      display: none;
    }

    .response-panel.active {
      display: block;
    }

    .response-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-muted);
    }

    .response-meta {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.85rem;
    }

    .response-meta .label {
      color: var(--text-muted);
    }

    .response-time {
      font-family: var(--font-mono);
      color: var(--text-secondary);
    }

    /* Parameter inputs with better styling */
    .param-input-group {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 1rem;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border-muted);
    }

    .param-input-group:last-child {
      border-bottom: none;
    }

    .param-label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .param-label .name {
      font-family: var(--font-mono);
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .param-label .type {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .param-input {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .param-input input {
      background: var(--surface-sunken);
      border: 1px solid var(--border-muted);
    }

    .param-input input:focus {
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(63, 184, 175, 0.15);
    }

    .param-input .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* PostgreSQL Database Browser Styles */
    .db-browser {
      display: flex;
      gap: 1.5rem;
      height: calc(100vh - 200px);
      min-height: 500px;
    }

    .db-sidebar {
      width: 280px;
      background: var(--surface-raised);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .db-sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-default);
      background: var(--surface-overlay);
    }

    .db-sidebar-header h4 {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .db-search {
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: var(--surface-base);
      border: 1px solid var(--border-muted);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.85rem;
    }

    .db-search:focus {
      outline: none;
      border-color: var(--primary-500);
    }

    .db-table-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .db-schema-group {
      margin-bottom: 0.5rem;
    }

    .db-schema-name {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      padding: 0.5rem 0.5rem 0.25rem;
    }

    .db-table-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.15s;
    }

    .db-table-item:hover {
      background: var(--surface-highlight);
    }

    .db-table-item.active {
      background: var(--surface-overlay);
      border-left: 2px solid var(--primary-500);
    }

    .db-table-icon {
      color: var(--primary-500);
      font-size: 0.9rem;
    }

    .db-table-name {
      flex: 1;
      font-family: var(--font-mono);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .db-table-count {
      font-size: 0.7rem;
      color: var(--text-muted);
      background: var(--surface-sunken);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
    }

    .db-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow: hidden;
    }

    .db-tabs {
      display: flex;
      gap: 0.5rem;
      border-bottom: 1px solid var(--border-default);
      padding-bottom: 0.5rem;
    }

    .db-tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 0.85rem;
      cursor: pointer;
      border-radius: 6px 6px 0 0;
      transition: all 0.15s;
    }

    .db-tab:hover {
      color: var(--text-primary);
      background: var(--surface-highlight);
    }

    .db-tab.active {
      color: var(--primary-500);
      background: var(--surface-overlay);
      border-bottom: 2px solid var(--primary-500);
    }

    .db-content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .db-panel {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow: hidden;
    }

    .db-panel.active {
      display: flex;
    }

    /* Schema tab styles */
    .db-schema-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .db-schema-table th {
      text-align: left;
      padding: 0.75rem 1rem;
      background: var(--surface-overlay);
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border-default);
    }

    .db-schema-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-muted);
    }

    .db-schema-table tr:hover td {
      background: var(--surface-highlight);
    }

    .db-col-name {
      font-family: var(--font-mono);
      font-weight: 500;
      color: var(--text-primary);
    }

    .db-col-type {
      font-family: var(--font-mono);
      color: var(--info);
    }

    .db-col-nullable {
      font-size: 0.75rem;
    }

    .db-col-nullable.yes {
      color: var(--text-muted);
    }

    .db-col-nullable.no {
      color: var(--warning);
    }

    .db-col-default {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .db-badge {
      display: inline-block;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      margin-left: 0.5rem;
    }

    .db-badge.pk {
      background: var(--warning-muted);
      color: var(--warning);
    }

    .db-badge.fk {
      background: rgba(88, 166, 255, 0.15);
      color: var(--info);
    }

    .db-badge.unique {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }

    /* Data tab styles */
    .db-data-container {
      flex: 1;
      overflow: auto;
      background: var(--surface-raised);
      border: 1px solid var(--border-default);
      border-radius: 8px;
    }

    .db-data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .db-data-table th {
      position: sticky;
      top: 0;
      text-align: left;
      padding: 0.6rem 0.75rem;
      background: var(--surface-overlay);
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      border-bottom: 1px solid var(--border-default);
      white-space: nowrap;
    }

    .db-data-table td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border-muted);
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: var(--font-mono);
      font-size: 0.8rem;
    }

    .db-data-table tr:hover td {
      background: var(--surface-highlight);
    }

    .db-null {
      color: var(--text-muted);
      font-style: italic;
    }

    .db-pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--surface-raised);
      border: 1px solid var(--border-default);
      border-top: none;
      border-radius: 0 0 8px 8px;
      font-size: 0.85rem;
    }

    .db-pagination-info {
      color: var(--text-secondary);
    }

    .db-pagination-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .db-pagination button {
      padding: 0.4rem 0.75rem;
      font-size: 0.8rem;
      background: var(--surface-overlay);
      border: 1px solid var(--border-default);
    }

    .db-pagination button:disabled {
      opacity: 0.4;
    }

    /* Query tab styles */
    .db-query-editor {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .db-query-input {
      width: 100%;
      min-height: 120px;
      padding: 1rem;
      background: var(--surface-sunken);
      border: 1px solid var(--border-muted);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 0.9rem;
      line-height: 1.5;
      resize: vertical;
    }

    .db-query-input:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(63, 184, 175, 0.15);
    }

    .db-query-actions {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .db-query-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .db-query-result {
      flex: 1;
      overflow: auto;
    }

    .db-connection-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: var(--surface-raised);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
    }

    .db-connection-status .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .db-connection-status .status-dot.healthy {
      background: var(--success);
    }

    .db-connection-status .status-dot.unhealthy {
      background: var(--error);
    }

    .db-connection-info {
      color: var(--text-secondary);
      font-family: var(--font-mono);
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <!-- First Run Modal -->
  <div id="firstRunModal" class="modal-overlay hidden">
    <div class="modal">
      <h2 id="authTitle">üëã Welcome</h2>
      <p id="authSubtitle">Create your identity to get started with the service dashboard.</p>
      <form id="registerForm">
        <div class="form-group" id="regNameGroup">
          <label for="regName">Name</label>
          <input type="text" id="regName" placeholder="Enter your name" required>
        </div>
        <div class="form-group">
          <label for="regEmail">Email</label>
          <input type="email" id="regEmail" placeholder="you@example.com" required>
        </div>
        <div class="form-group">
          <label for="regPassword">Password</label>
          <input type="password" id="regPassword" placeholder="Create password" required>
        </div>
        <div class="form-group" id="orgNameGroup">
          <label for="orgName">Organization</label>
          <input type="text" id="orgName" placeholder="Acme Inc" required>
        </div>
        <div class="form-group" id="orgSlugGroup">
          <label for="orgSlug">Organization Slug</label>
          <input type="text" id="orgSlug" placeholder="acme" required>
        </div>
        <div id="regError" style="color: var(--error); font-size: 0.85rem; margin-bottom: 1rem; display: none;"></div>
        <div class="actions">
          <button type="submit" id="regSubmit">Create Identity</button>
          <button type="button" class="secondary" id="loginToggleBtn" onclick="handleAuthSecondary()">Login</button>
          <button type="button" class="secondary" onclick="skipRegistration()">Skip for Now</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <h1>
      <span class="header-logo">‚ö°</span>
      Service Admin
    </h1>
    <div class="user-info" id="userInfo">
      <select id="orgSelect" class="org-select hidden" title="Organization context"></select>
      <div class="user-details" id="userDetails" style="display: none;">
        <span class="user-name" id="userName">Not signed in</span>
      </div>
      <button id="logoutBtn" class="logout-btn" style="display: none;" onclick="logout()" title="Sign out">Sign out</button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-section">Services</div>
      <div id="serviceTabs"></div>

      <div class="sidebar-divider"></div>

      <div class="sidebar-section">Quick Actions</div>
      <div class="quick-actions">
        <button class="quick-action-btn" onclick="quickAction('catalog', 'GET', '/api/resources', 'List Resources')">
          <span class="icon">üì¶</span>
          <span class="label">List Resources</span>
          <span class="method-badge get">GET</span>
        </button>
        <button class="quick-action-btn" onclick="quickAction('catalog', 'GET', '/api/bootstrap/summary', 'Catalog Summary')">
          <span class="icon">üìä</span>
          <span class="label">Catalog Summary</span>
          <span class="method-badge get">GET</span>
        </button>
        <button class="quick-action-btn" onclick="quickAction('identity', 'GET', '/api/orgs', 'List Organizations')">
          <span class="icon">üè¢</span>
          <span class="label">List Organizations</span>
          <span class="method-badge get">GET</span>
        </button>
        <button class="quick-action-btn" onclick="quickAction('identity', 'GET', '/api/dashboard', 'Dashboard')">
          <span class="icon">üìã</span>
          <span class="label">Dashboard</span>
          <span class="method-badge get">GET</span>
        </button>
        <button class="quick-action-btn" onclick="quickAction('logging', 'GET', '/api/logs/streams', 'Log Streams')">
          <span class="icon">üìú</span>
          <span class="label">Log Streams</span>
          <span class="method-badge get">GET</span>
        </button>
        <button class="quick-action-btn" onclick="quickAction('integrations', 'GET', '/api/integrations/status', 'Integration Status')">
          <span class="icon">üîå</span>
          <span class="label">Integration Status</span>
          <span class="method-badge get">GET</span>
        </button>
        <button class="quick-action-btn" onclick="quickAction('assistants', 'GET', '/api/assistants', 'List Assistants')">
          <span class="icon">ü§ñ</span>
          <span class="label">List Assistants</span>
          <span class="method-badge get">GET</span>
        </button>
      </div>
    </nav>

    <!-- Quick Action Results Panel -->
    <div class="quick-results-panel" id="quickResultsPanel">
      <div class="quick-results-header">
        <div class="title">
          <span id="quickResultsTitle">Result</span>
          <span class="status-badge" id="quickResultsStatus"></span>
        </div>
        <button class="close-btn" onclick="closeQuickResults()">&times;</button>
      </div>
      <pre class="quick-results-body" id="quickResultsBody"></pre>
    </div>

    <!-- Content -->
    <main class="content" id="contentArea">
      <div class="loading" id="initialLoading">
        <div class="spinner"></div>
        Discovering services...
      </div>
    </main>
  </div>

  <script>
    // Service configuration
    const SERVICES = [
      { id: 'identity', name: 'Identity', port: 5001 },
      { id: 'logging', name: 'Logging', port: 5002 },
      { id: 'catalog', name: 'Catalog', port: 5003 },
      { id: 'assistants', name: 'Assistants', port: 5004 },
      { id: 'messaging', name: 'Messaging', port: 5005 },
      { id: 'runtime', name: 'Runtime', port: 5006 },
      { id: 'integrations', name: 'Integrations', port: 5007 },
      { id: 'network', name: 'Network', port: 5054 },
      { id: 'postgresql', name: 'PostgreSQL', port: 5432 }
    ];

    // State
    let serviceSpecs = {};
    let currentService = null;
    let currentUser = null;
    let currentOrgId = null;
    let authMode = 'register'; // register | login | org

    // Initialize
    document.addEventListener('DOMContentLoaded', init);

    async function init() {
      checkFirstRun();
      renderServiceTabs();
      await discoverServices();

      // Select first service by default
      if (SERVICES.length > 0) {
        selectService(SERVICES[0].id);
      }
    }

    function checkFirstRun() {
      const user = localStorage.getItem('dashboard_user');
      if (user) {
        currentUser = JSON.parse(user);
        currentOrgId = localStorage.getItem('dashboard_org_id');
        updateUserDisplay();
      } else {
        showRegister();
      }
    }

    function updateUserDisplay() {
      if (currentUser) {
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userDetails').style.display = 'flex';
        document.getElementById('logoutBtn').style.display = 'inline-flex';
        const userDetails = document.getElementById('userDetails');
        if (!userDetails.querySelector('.avatar')) {
          const avatar = document.createElement('div');
          avatar.className = 'avatar';
          avatar.textContent = currentUser.name[0].toUpperCase();
          userDetails.insertBefore(avatar, userDetails.firstChild);
        }

        // Load org context for scoped services (required)
        loadOrganizations().catch(() => {});
      }
    }

    function slugify(str) {
      return (str || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(0, 40) || 'org';
    }

    function showAuthModal() {
      document.getElementById('firstRunModal').classList.remove('hidden');
      document.getElementById('regError').style.display = 'none';
    }

    function hideAuthModal() {
      document.getElementById('firstRunModal').classList.add('hidden');
    }

    function setAuthCopy(title, subtitle) {
      document.getElementById('authTitle').textContent = title;
      document.getElementById('authSubtitle').textContent = subtitle;
    }

    function toggleGroup(id, visible) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = visible ? '' : 'none';
      const input = el.querySelector('input');
      if (input) input.required = visible;
    }

    function showRegister() {
      authMode = 'register';
      setAuthCopy('üëã Welcome', 'Create your identity and organization to get started with the service dashboard.');
      document.getElementById('regSubmit').textContent = 'Create Identity';
      document.getElementById('loginToggleBtn').textContent = 'Login';
      toggleGroup('regNameGroup', true);
      toggleGroup('orgNameGroup', true);
      toggleGroup('orgSlugGroup', true);
      showAuthModal();
    }

    function showLogin() {
      authMode = 'login';
      setAuthCopy('üîê Login', 'Sign in to continue.');
      document.getElementById('regSubmit').textContent = 'Login';
      document.getElementById('loginToggleBtn').textContent = 'Create Account';
      toggleGroup('regNameGroup', false);
      toggleGroup('orgNameGroup', false);
      toggleGroup('orgSlugGroup', false);
      showAuthModal();
    }

    function showOrgSetup() {
      authMode = 'org';
      setAuthCopy('üè¢ Organization Required', 'Create an organization to continue.');
      document.getElementById('regSubmit').textContent = 'Create Organization';
      document.getElementById('loginToggleBtn').textContent = 'Logout';
      toggleGroup('regNameGroup', false);
      toggleGroup('orgNameGroup', true);
      toggleGroup('orgSlugGroup', true);
      showAuthModal();
    }

    function handleAuthSecondary() {
      if (authMode === 'login') {
        showRegister();
        return;
      }
      if (authMode === 'org') {
        logout();
        return;
      }
      showLogin();
    }

    function logout() {
      currentUser = null;
      currentOrgId = null;
      localStorage.removeItem('dashboard_user');
      localStorage.removeItem('dashboard_org_id');
      const orgSelect = document.getElementById('orgSelect');
      orgSelect.classList.add('hidden');
      orgSelect.innerHTML = '';
      document.getElementById('userName').textContent = 'Not signed in';
      document.getElementById('userDetails').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'none';
      const avatar = document.querySelector('#userDetails .avatar');
      if (avatar) avatar.remove();
      showRegister();
    }

    async function loadOrganizations() {
      if (!currentUser?.token) return;

      const orgSelect = document.getElementById('orgSelect');
      orgSelect.classList.remove('hidden');

      const res = await fetch('/proxy/5001/api/orgs', {
        headers: {
          ...(currentUser?.token ? { 'Authorization': `Bearer ${currentUser.token}` } : {}),
        },
      });

      if (!res.ok) return;
      const data = await res.json().catch(() => null);
      let orgs = data?.organizations || [];

      if (orgs.length === 0) {
        // Require explicit org creation on first use
        showOrgSetup();
        return;
      }

      if (orgs.length === 0) {
        orgSelect.innerHTML = `<option value="">No organizations</option>`;
        currentOrgId = null;
        localStorage.removeItem('dashboard_org_id');
        return;
      }

      orgSelect.innerHTML = orgs.map(o => `<option value="${o.id}">${o.name}</option>`).join('');

      const preferred = currentOrgId && orgs.find(o => o.id === currentOrgId) ? currentOrgId : orgs[0].id;
      orgSelect.value = preferred;
      currentOrgId = preferred;
      localStorage.setItem('dashboard_org_id', currentOrgId);
    }

    document.getElementById('orgSelect').addEventListener('change', (e) => {
      const next = e.target.value || null;
      currentOrgId = next;
      if (currentOrgId) localStorage.setItem('dashboard_org_id', currentOrgId);
      else localStorage.removeItem('dashboard_org_id');
    });

    // Convenience: auto-suggest org slug from org name (unless user already typed one)
    document.getElementById('orgName').addEventListener('input', () => {
      const orgName = document.getElementById('orgName').value;
      const orgSlugEl = document.getElementById('orgSlug');
      if (!orgSlugEl.value) {
        orgSlugEl.value = slugify(orgName);
      }
    });

    // Registration - discovers endpoint from Identity service OpenAPI spec
    let identitySpec = null;
    let registerEndpoint = null;
    let identityApiBase = '/api';

    async function discoverIdentityEndpoints() {
      try {
        const res = await fetch('/proxy/5001/docs/openapi.json');
        if (res.ok) {
          identitySpec = await res.json();
          identityApiBase = (identitySpec?.servers?.[0]?.url || '/api').replace(/\/$/, '') || '/api';
          // Find registration endpoint (look for register, signup, create user patterns)
          for (const [path, methods] of Object.entries(identitySpec.paths || {})) {
            for (const [method, details] of Object.entries(methods)) {
              const lowerPath = path.toLowerCase();
              const lowerSummary = (details.summary || '').toLowerCase();
              const lowerOpId = (details.operationId || '').toLowerCase();
              if (method === 'post' &&
                  (lowerPath.includes('/user/register') || lowerPath.includes('signup') ||
                   lowerSummary.includes('register') || lowerSummary.includes('create user') ||
                   lowerOpId.includes('register') || lowerOpId.includes('signup'))) {
                registerEndpoint = { path, method, ...details };
                console.log('Discovered register endpoint:', path);
                break;
              }
            }
            if (registerEndpoint) break;
          }
        }
      } catch (err) {
        console.log('Could not discover Identity endpoints:', err);
      }
    }

    // Discover on load
    discoverIdentityEndpoints();

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('regName').value;
      const email = document.getElementById('regEmail').value;
      const password = document.getElementById('regPassword').value;
      const orgName = document.getElementById('orgName').value;
      const orgSlugRaw = document.getElementById('orgSlug').value;
      const orgSlug = slugify(orgSlugRaw || orgName);
      const errorEl = document.getElementById('regError');
      const submitBtn = document.getElementById('regSubmit');
      const toggleBtn = document.getElementById('loginToggleBtn');

      submitBtn.disabled = true;
      toggleBtn.disabled = true;
      submitBtn.textContent = 'Creating...';
      errorEl.style.display = 'none';

      try {
        if (authMode === 'login') {
          const loginRes = await fetch('/proxy/5001/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });

          if (!loginRes.ok) {
            const err = await loginRes.json().catch(() => ({ message: 'Login failed' }));
            throw new Error(err.message || 'Login failed');
          }

          const data = await loginRes.json();
          currentUser = { name: data.user?.name || email, email: data.user?.email || email, token: data.token };
          localStorage.setItem('dashboard_user', JSON.stringify(currentUser));
          updateUserDisplay();
          hideAuthModal();
          return;
        }

        if (authMode === 'org') {
          if (!currentUser?.token) throw new Error('Login required');
          const createOrgRes = await fetch('/proxy/5001/api/orgs', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${currentUser.token}`,
            },
            body: JSON.stringify({ name: orgName, slug: orgSlug }),
          });

          if (!createOrgRes.ok) {
            const err = await createOrgRes.json().catch(() => ({ message: 'Organization creation failed' }));
            throw new Error(err.message || 'Organization creation failed');
          }

          const org = await createOrgRes.json();
          currentOrgId = org.id;
          localStorage.setItem('dashboard_org_id', currentOrgId);
          await loadOrganizations();
          hideAuthModal();
          return;
        }

        // Register flow: create user, then create org (required)
        const endpointPath = registerEndpoint
          ? `${identityApiBase}${registerEndpoint.path}`
          : `${identityApiBase}/auth/register`;
        const endpoint = `/proxy/5001${endpointPath}`;

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password })
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({ message: 'Registration failed' }));
          throw new Error(err.message || 'Registration failed');
        }

        const data = await response.json();
        currentUser = { name, email, token: data.token };
        localStorage.setItem('dashboard_user', JSON.stringify(currentUser));

        const createOrgRes = await fetch('/proxy/5001/api/orgs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentUser.token}`,
          },
          body: JSON.stringify({ name: orgName, slug: orgSlug }),
        });

        if (!createOrgRes.ok) {
          const err = await createOrgRes.json().catch(() => ({ message: 'Organization creation failed' }));
          throw new Error(err.message || 'Organization creation failed');
        }

        const org = await createOrgRes.json();
        currentOrgId = org.id;
        localStorage.setItem('dashboard_org_id', currentOrgId);
        updateUserDisplay();
        hideAuthModal();
      } catch (err) {
        const msg = err.message || 'Request failed';
        errorEl.textContent = msg;
        errorEl.style.display = 'block';

        // If user registration succeeded but org creation failed, switch to org-only mode
        // so the user can retry without re-registering.
        if (authMode === 'register' && currentUser?.token && !currentOrgId) {
          showOrgSetup();
          errorEl.textContent = msg;
          errorEl.style.display = 'block';
        }
      }

      submitBtn.disabled = false;
      toggleBtn.disabled = false;
      if (authMode === 'login') submitBtn.textContent = 'Login';
      else if (authMode === 'org') submitBtn.textContent = 'Create Organization';
      else submitBtn.textContent = 'Create Identity';
    });

    function skipRegistration() {
      document.getElementById('firstRunModal').classList.add('hidden');
    }

    // Service Tabs
    function renderServiceTabs() {
      const container = document.getElementById('serviceTabs');
      container.innerHTML = SERVICES.map(svc => `
        <div class="service-tab" data-service="${svc.id}" onclick="selectService('${svc.id}')">
          <div class="status" id="status-${svc.id}"></div>
          <span class="name">${svc.name}</span>
          <span class="port">:${svc.port}</span>
        </div>
      `).join('');
    }

    async function selectService(serviceId) {
      currentService = serviceId;

      // Update tab states
      document.querySelectorAll('.service-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.service === serviceId);
      });

      // Render service panel
      renderServicePanel(serviceId);
    }

    // Service Discovery
    async function discoverServices() {
      document.getElementById('initialLoading').style.display = 'flex';

      const discoveries = SERVICES.map(async (svc) => {
        try {
          // Special handling for PostgreSQL - check via service-admin's /db/health
          if (svc.id === 'postgresql') {
            try {
              const healthRes = await fetch('/db/health', {
                signal: AbortSignal.timeout(3000)
              });
              if (healthRes.ok) {
                document.getElementById(`status-${svc.id}`).classList.remove('unhealthy');
                serviceSpecs[svc.id] = { info: { title: 'PostgreSQL Database' }, paths: {} };
                return;
              }
            } catch {}
            document.getElementById(`status-${svc.id}`).classList.add('unhealthy');
            return;
          }

          // OpenAPI endpoint for other services
          const endpoints = [
            `/docs/openapi.json`
          ];

          for (const endpoint of endpoints) {
            try {
              const res = await fetch(`/proxy/${svc.port}${endpoint}`, {
                signal: AbortSignal.timeout(3000)
              });
              if (res.ok) {
                const spec = await res.json();
                serviceSpecs[svc.id] = spec;
                document.getElementById(`status-${svc.id}`).classList.remove('unhealthy');
                return;
              }
            } catch {}
          }

          // Try health check
          try {
            const healthRes = await fetch(`/proxy/${svc.port}/health`, {
              signal: AbortSignal.timeout(2000)
            });
            if (healthRes.ok) {
              document.getElementById(`status-${svc.id}`).classList.remove('unhealthy');
              serviceSpecs[svc.id] = { info: { title: svc.name }, paths: {} };
              return;
            }
          } catch {}

          document.getElementById(`status-${svc.id}`).classList.add('unhealthy');
        } catch (err) {
          document.getElementById(`status-${svc.id}`).classList.add('unhealthy');
        }
      });

      await Promise.all(discoveries);
      document.getElementById('initialLoading').style.display = 'none';
    }

    // ========================================
    // OpenAPI Schema Helpers
    // ========================================

    // Resolve a $ref in the OpenAPI spec
    function resolveRef(spec, ref) {
      if (!ref || !ref.startsWith('#/')) return null;
      const parts = ref.slice(2).split('/');
      let obj = spec;
      for (const part of parts) {
        obj = obj?.[part];
        if (!obj) return null;
      }
      return obj;
    }

    // Get the schema for a request body
    function getRequestBodySchema(spec, endpoint) {
      const requestBody = endpoint.requestBody;
      if (!requestBody) return null;

      // Handle $ref at requestBody level
      let body = requestBody;
      if (body.$ref) {
        body = resolveRef(spec, body.$ref);
      }

      const content = body?.content;
      if (!content) return null;

      // Prefer application/json
      const jsonContent = content['application/json'] || content['*/*'] || Object.values(content)[0];
      if (!jsonContent?.schema) return null;

      let schema = jsonContent.schema;
      if (schema.$ref) {
        schema = resolveRef(spec, schema.$ref);
      }

      return schema;
    }

    // Generate example value for a schema type
    function generateExampleValue(schema, spec, depth = 0) {
      if (!schema || depth > 5) return null;

      // Handle $ref
      if (schema.$ref) {
        schema = resolveRef(spec, schema.$ref);
        if (!schema) return null;
      }

      // Use example if provided
      if (schema.example !== undefined) return schema.example;
      if (schema.default !== undefined) return schema.default;

      // Handle enum
      if (schema.enum && schema.enum.length > 0) {
        return schema.enum[0];
      }

      const type = schema.type;

      if (type === 'object' || schema.properties) {
        const obj = {};
        const props = schema.properties || {};
        const required = schema.required || [];

        for (const [key, propSchema] of Object.entries(props)) {
          // Include required fields and a few optional ones
          if (required.includes(key) || Object.keys(obj).length < 5) {
            obj[key] = generateExampleValue(propSchema, spec, depth + 1);
          }
        }
        return obj;
      }

      if (type === 'array') {
        const itemSchema = schema.items;
        if (itemSchema) {
          const item = generateExampleValue(itemSchema, spec, depth + 1);
          return item !== null ? [item] : [];
        }
        return [];
      }

      if (type === 'string') {
        if (schema.format === 'email') return 'user@example.com';
        if (schema.format === 'uri' || schema.format === 'url') return 'https://example.com';
        if (schema.format === 'uuid') return '550e8400-e29b-41d4-a716-446655440000';
        if (schema.format === 'date') return '2024-01-15';
        if (schema.format === 'date-time') return '2024-01-15T09:30:00Z';
        if (schema.format === 'password') return 'your-password';
        if (schema.minLength) return 'x'.repeat(schema.minLength);
        return 'string';
      }

      if (type === 'integer' || type === 'number') {
        if (schema.minimum !== undefined) return schema.minimum;
        if (schema.maximum !== undefined) return Math.min(schema.maximum, 100);
        return type === 'integer' ? 0 : 0.0;
      }

      if (type === 'boolean') return true;

      return null;
    }

    // Generate a JSON template string from a schema
    function generateJsonTemplate(spec, endpoint) {
      const schema = getRequestBodySchema(spec, endpoint);
      if (!schema) return '{\n  \n}';

      const example = generateExampleValue(schema, spec);
      if (example === null) return '{\n  \n}';

      try {
        return JSON.stringify(example, null, 2);
      } catch {
        return '{\n  \n}';
      }
    }

    // Extract field documentation from a schema
    function getSchemaFields(spec, endpoint) {
      const schema = getRequestBodySchema(spec, endpoint);
      if (!schema) return [];

      let resolved = schema;
      if (schema.$ref) {
        resolved = resolveRef(spec, schema.$ref);
      }

      const properties = resolved?.properties || {};
      const required = resolved?.required || [];

      return Object.entries(properties).map(([name, propSchema]) => {
        let prop = propSchema;
        if (prop.$ref) {
          prop = resolveRef(spec, prop.$ref) || prop;
        }

        let type = prop.type || 'any';
        if (prop.enum) type = 'enum';
        if (prop.format) type = `${type} (${prop.format})`;
        if (type === 'array' && prop.items) {
          const itemType = prop.items.type || (prop.items.$ref ? 'object' : 'any');
          type = `${itemType}[]`;
        }

        return {
          name,
          type,
          required: required.includes(name),
          description: prop.description || '',
          example: prop.example,
          enum: prop.enum,
          format: prop.format
        };
      });
    }

    // Get parameter documentation with better formatting
    function getParamDocs(param) {
      let type = param.schema?.type || 'string';
      if (param.schema?.format) type = `${type} (${param.schema.format})`;
      if (param.schema?.enum) type = 'enum';

      return {
        name: param.name,
        type,
        required: param.required || false,
        description: param.description || '',
        example: param.example || param.schema?.example,
        enum: param.schema?.enum
      };
    }

    // ========================================
    // Render Service Panel
    // ========================================

    function renderServicePanel(serviceId) {
      const service = SERVICES.find(s => s.id === serviceId);
      const spec = serviceSpecs[serviceId];
      const content = document.getElementById('contentArea');

      // Special handling for PostgreSQL
      if (serviceId === 'postgresql') {
        renderPostgresPanel();
        return;
      }

      if (!spec) {
        content.innerHTML = `
          <div class="panel-header">
            <h2>${service.name}</h2>
            <div class="meta">Port ${service.port}</div>
          </div>
          <div class="empty-state">
            <div class="icon">üîå</div>
            <p>Could not discover API specification for this service.</p>
            <p style="margin-top: 0.5rem; font-size: 0.85rem;">
              Make sure the service exposes /docs/openapi.json
            </p>
          </div>
        `;
        return;
      }

      const endpoints = [];
      if (spec.paths) {
        for (const [path, methods] of Object.entries(spec.paths)) {
          for (const [method, details] of Object.entries(methods)) {
            if (['get', 'post', 'put', 'delete', 'patch'].includes(method)) {
              endpoints.push({ path, method, ...details });
            }
          }
        }
      }

      content.innerHTML = `
        <div class="panel-header">
          <h2>${spec.info?.title || service.name}</h2>
          <div class="meta">
            ${spec.info?.version ? `v${spec.info.version} ¬∑ ` : ''}
            Port ${service.port} ¬∑ ${endpoints.length} endpoints
          </div>
        </div>

        <div class="card">
          <h3>üì° API Endpoints</h3>
          ${endpoints.length > 0 ? `
            <div class="endpoints-list">
              ${endpoints.map((ep, idx) => `
                <div class="endpoint-item" onclick="toggleEndpoint('${serviceId}', ${idx})">
                  <span class="method ${ep.method}">${ep.method.toUpperCase()}</span>
                  <span class="path">${ep.path}</span>
                  <span class="summary">${ep.summary || ''}</span>
                </div>
                <div class="api-tester" id="tester-${serviceId}-${idx}">
                  ${renderApiTester(service, ep, idx)}
                </div>
              `).join('')}
            </div>
          ` : '<div class="empty-state"><p>No endpoints discovered</p></div>'}
        </div>

        ${spec.info?.description ? `
          <div class="card">
            <h3>üìñ Documentation</h3>
            <p style="color: var(--text-secondary); line-height: 1.6;">${spec.info.description}</p>
          </div>
        ` : ''}
      `;

      // Store endpoints for later reference
      window.currentEndpoints = endpoints;
    }

    function renderApiTester(service, endpoint, idx) {
      const spec = serviceSpecs[service.id];
      const hasBody = ['post', 'put', 'patch'].includes(endpoint.method);
      const params = endpoint.parameters || [];
      const pathParams = params.filter(p => p.in === 'path').map(p => getParamDocs(p));
      const queryParams = params.filter(p => p.in === 'query').map(p => getParamDocs(p));

      // Get schema-based documentation
      const bodyFields = hasBody ? getSchemaFields(spec, endpoint) : [];
      const bodyTemplate = hasBody ? generateJsonTemplate(spec, endpoint) : '';

      // Escape the template for use in HTML attribute
      const escapedTemplate = bodyTemplate.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

      return `
        <div class="endpoint-docs">
          <div class="tester-header">
            <span class="method ${endpoint.method}">${endpoint.method.toUpperCase()}</span>
            <span class="path">${endpoint.path}</span>
          </div>

          ${endpoint.summary || endpoint.description ? `
            <p class="endpoint-summary">${endpoint.description || endpoint.summary}</p>
          ` : ''}

          ${pathParams.length > 0 ? `
            <div class="schema-section">
              <div class="schema-section-title">
                <span>Path Parameters</span>
              </div>
              <div class="schema-fields">
                ${pathParams.map(p => `
                  <div class="param-input-group">
                    <div class="param-label">
                      <span class="name">${p.name}${p.required ? ' *' : ''}</span>
                      <span class="type">${p.type}</span>
                    </div>
                    <div class="param-input">
                      <input type="text" id="param-${idx}-${p.name}"
                             placeholder="${p.example || p.description || `Enter ${p.name}`}">
                      ${p.description ? `<span class="hint">${p.description}</span>` : ''}
                      ${p.enum ? `<span class="hint">Options: ${p.enum.join(', ')}</span>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          ${queryParams.length > 0 ? `
            <div class="schema-section">
              <div class="schema-section-title">
                <span>Query Parameters</span>
              </div>
              <div class="schema-fields">
                ${queryParams.map(p => `
                  <div class="param-input-group">
                    <div class="param-label">
                      <span class="name">${p.name}${p.required ? ' *' : ''}</span>
                      <span class="type">${p.type}</span>
                    </div>
                    <div class="param-input">
                      <input type="text" id="query-${idx}-${p.name}"
                             placeholder="${p.example || p.description || `Enter ${p.name}`}">
                      ${p.description ? `<span class="hint">${p.description}</span>` : ''}
                      ${p.enum ? `<span class="hint">Options: ${p.enum.join(', ')}</span>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          ${hasBody ? `
            ${bodyFields.length > 0 ? `
              <div class="schema-section">
                <div class="schema-section-title">
                  <span>Request Body Schema</span>
                </div>
                <div class="schema-fields">
                  ${bodyFields.map(f => `
                    <div class="schema-field">
                      <div class="schema-field-name">
                        ${f.name}
                        ${f.required ? '<span class="required-badge">required</span>' : ''}
                      </div>
                      <div class="schema-field-type">${f.type}</div>
                      <div class="schema-field-desc">
                        ${f.description || '<span style="color: var(--text-muted);">No description</span>'}
                        ${f.enum ? `<div class="schema-field-example">Allowed: ${f.enum.join(' | ')}</div>` : ''}
                        ${f.example !== undefined ? `<div class="schema-field-example">Example: ${JSON.stringify(f.example)}</div>` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <div class="request-body-section">
              <div class="request-body-header">
                <label>Request Body (JSON)</label>
                <div class="request-body-actions">
                  <button type="button" onclick="resetBodyTemplate('${service.id}', ${idx})">Reset Template</button>
                  <button type="button" onclick="formatJsonBody(${idx})">Format JSON</button>
                </div>
              </div>
              <textarea id="body-${idx}" class="body-editor" data-template="${escapedTemplate}">${bodyTemplate}</textarea>
            </div>
          ` : ''}
        </div>

        <div class="tester-actions">
          <button onclick="executeRequest('${service.id}', ${idx})">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
            </svg>
            Send Request
          </button>
          <button class="secondary" onclick="toggleEndpoint('${service.id}', ${idx})">Close</button>
        </div>

        <div class="response-panel" id="response-${idx}">
          <div class="response-header">
            <div class="response-meta">
              <span class="label">Status:</span>
              <span class="code" id="response-code-${idx}"></span>
              <span class="response-time" id="response-time-${idx}"></span>
            </div>
          </div>
          <pre class="response-body" id="response-body-${idx}"></pre>
        </div>
      `;
    }

    // Helper to reset body textarea to template
    function resetBodyTemplate(serviceId, idx) {
      const textarea = document.getElementById(`body-${idx}`);
      if (textarea) {
        textarea.value = textarea.dataset.template || '{\n  \n}';
      }
    }

    // Helper to format JSON in body textarea
    function formatJsonBody(idx) {
      const textarea = document.getElementById(`body-${idx}`);
      if (textarea) {
        try {
          const parsed = JSON.parse(textarea.value);
          textarea.value = JSON.stringify(parsed, null, 2);
        } catch (e) {
          // If invalid JSON, don't change it
          console.warn('Invalid JSON, cannot format');
        }
      }
    }

    function toggleEndpoint(serviceId, idx) {
      const tester = document.getElementById(`tester-${serviceId}-${idx}`);
      const endpointItem = tester.previousElementSibling;
      const isActive = tester.classList.toggle('active');

      // Toggle expanded class on endpoint item for visual feedback
      if (isActive) {
        endpointItem.classList.add('expanded');
        // Scroll into view with some padding
        setTimeout(() => {
          tester.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 50);
      } else {
        endpointItem.classList.remove('expanded');
      }
    }

    // ========================================
    // PostgreSQL Database Browser
    // ========================================

    let dbTables = [];
    let currentDbTable = null;
    let currentDbTab = 'schema';
    let currentTableSchema = null;
    let currentTableData = null;
    let dbConnectionInfo = null;
    let tableSearchFilter = '';
    let availableDatabases = [];
    let currentDatabase = 'identity';

    // Helper to get auth headers for DB requests
    function getDbAuthHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      if (currentUser?.token) {
        headers['Authorization'] = `Bearer ${currentUser.token}`;
      }
      return headers;
    }

    async function loadDatabases() {
      if (!currentUser?.token) {
        availableDatabases = [];
        return false;
      }

      try {
        const res = await fetch('/db/databases', { headers: getDbAuthHeaders() });
        if (res.ok) {
          const data = await res.json();
          availableDatabases = data.databases || [];
          if (availableDatabases.length > 0 && !availableDatabases.includes(currentDatabase)) {
            currentDatabase = availableDatabases[0];
          }
          return true;
        }
      } catch (e) {
        console.error('Failed to load databases:', e);
      }
      availableDatabases = [];
      return false;
    }

    async function checkDbConnection() {
      if (!currentUser?.token) {
        dbConnectionInfo = null;
        return false;
      }

      try {
        const res = await fetch(`/db/${currentDatabase}/health`, { headers: getDbAuthHeaders() });
        if (res.ok) {
          dbConnectionInfo = await res.json();
          return true;
        }
      } catch (e) {}
      dbConnectionInfo = null;
      return false;
    }

    async function loadDbTables() {
      if (!currentUser?.token) return;

      try {
        const res = await fetch(`/db/${currentDatabase}/tables`, { headers: getDbAuthHeaders() });
        if (res.ok) {
          const data = await res.json();
          dbTables = data.tables || [];
          renderDbTableList();
        }
      } catch (e) {
        console.error('Failed to load tables:', e);
      }
    }

    function switchDatabase(db) {
      currentDatabase = db;
      currentDbTable = null;
      currentTableSchema = null;
      currentTableData = null;
      dbTables = [];
      checkDbConnection().then(() => loadDbTables());
      // Clear content areas
      const schemaContent = document.getElementById('dbSchemaContent');
      const dataContent = document.getElementById('dbDataContent');
      if (schemaContent) schemaContent.innerHTML = '<div class="empty-state" style="padding: 3rem;"><div class="icon">üìã</div><p>Select a table to view its schema</p></div>';
      if (dataContent) dataContent.innerHTML = '<div class="empty-state" style="padding: 3rem;"><div class="icon">üìä</div><p>Select a table to browse its data</p></div>';
    }

    function renderDbTableList() {
      const container = document.getElementById('dbTableList');
      if (!container) return;

      // Group tables by schema
      const schemas = {};
      const filter = tableSearchFilter.toLowerCase();

      dbTables.forEach(t => {
        if (filter && !t.table_name.toLowerCase().includes(filter)) return;
        if (!schemas[t.table_schema]) schemas[t.table_schema] = [];
        schemas[t.table_schema].push(t);
      });

      container.innerHTML = Object.entries(schemas).map(([schema, tables]) => `
        <div class="db-schema-group">
          <div class="db-schema-name">${schema}</div>
          ${tables.map(t => `
            <div class="db-table-item ${currentDbTable?.table_name === t.table_name && currentDbTable?.table_schema === t.table_schema ? 'active' : ''}"
                 onclick="selectDbTable('${t.table_schema}', '${t.table_name}')">
              <span class="db-table-icon">${t.table_type === 'VIEW' ? 'üëÅ' : 'üìã'}</span>
              <span class="db-table-name">${t.table_name}</span>
              <span class="db-table-count">${t.column_count} cols</span>
            </div>
          `).join('')}
        </div>
      `).join('') || '<div class="empty-state" style="padding: 2rem;"><p>No tables found</p></div>';
    }

    async function selectDbTable(schema, tableName) {
      currentDbTable = { table_schema: schema, table_name: tableName };
      currentTableData = null; // Reset data when switching tables
      renderDbTableList();

      // Load based on current tab
      if (currentDbTab === 'schema') {
        await loadTableSchema(schema, tableName);
      } else if (currentDbTab === 'data') {
        await loadTableData(schema, tableName);
      }

      // Also preload schema if on data tab (for reference)
      if (currentDbTab === 'data') {
        loadTableSchema(schema, tableName);
      }
    }

    async function loadTableSchema(schema, tableName) {
      const container = document.getElementById('dbSchemaContent');
      if (!container) return;

      container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading schema...</div>';

      try {
        const res = await fetch(`/db/${currentDatabase}/tables/${encodeURIComponent(schema)}/${encodeURIComponent(tableName)}/schema`, {
          headers: getDbAuthHeaders()
        });
        if (res.ok) {
          currentTableSchema = await res.json();
          renderTableSchema();
        } else {
          const err = await res.json().catch(() => ({}));
          container.innerHTML = `<div class="empty-state"><p>${err.error || 'Failed to load schema'}</p></div>`;
        }
      } catch (e) {
        container.innerHTML = `<div class="empty-state"><p>Error: ${e.message}</p></div>`;
      }
    }

    function renderTableSchema() {
      const container = document.getElementById('dbSchemaContent');
      if (!container || !currentTableSchema) return;

      const { columns, constraints, indexes } = currentTableSchema;

      // Build constraint lookup
      const pkCols = new Set();
      const fkCols = new Set();
      const uniqueCols = new Set();

      constraints.forEach(c => {
        if (c.constraint_type === 'PRIMARY KEY') pkCols.add(c.column_name);
        if (c.constraint_type === 'FOREIGN KEY') fkCols.add(c.column_name);
        if (c.constraint_type === 'UNIQUE') uniqueCols.add(c.column_name);
      });

      container.innerHTML = `
        <div style="overflow: auto; flex: 1;">
          <table class="db-schema-table">
            <thead>
              <tr>
                <th>Column</th>
                <th>Type</th>
                <th>Nullable</th>
                <th>Default</th>
              </tr>
            </thead>
            <tbody>
              ${columns.map(col => `
                <tr>
                  <td>
                    <span class="db-col-name">${col.column_name}</span>
                    ${pkCols.has(col.column_name) ? '<span class="db-badge pk">PK</span>' : ''}
                    ${fkCols.has(col.column_name) ? '<span class="db-badge fk">FK</span>' : ''}
                    ${uniqueCols.has(col.column_name) ? '<span class="db-badge unique">UQ</span>' : ''}
                  </td>
                  <td>
                    <span class="db-col-type">${formatColumnType(col)}</span>
                  </td>
                  <td>
                    <span class="db-col-nullable ${col.is_nullable === 'YES' ? 'yes' : 'no'}">
                      ${col.is_nullable === 'YES' ? 'nullable' : 'required'}
                    </span>
                  </td>
                  <td>
                    <span class="db-col-default">${col.column_default || '-'}</span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        ${indexes.length > 0 ? `
          <div style="margin-top: 1.5rem;">
            <h4 style="font-size: 0.85rem; margin-bottom: 0.75rem; color: var(--text-secondary);">Indexes</h4>
            <div class="schema-fields">
              ${groupBy(indexes, 'index_name').map(([name, cols]) => `
                <div class="schema-field" style="grid-template-columns: 200px 1fr;">
                  <div class="schema-field-name">
                    ${name}
                    ${cols[0].is_primary ? '<span class="db-badge pk">Primary</span>' : ''}
                    ${cols[0].is_unique && !cols[0].is_primary ? '<span class="db-badge unique">Unique</span>' : ''}
                  </div>
                  <div class="db-col-type">${cols.map(c => c.column_name).join(', ')}</div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      `;
    }

    function formatColumnType(col) {
      let type = col.data_type;
      if (col.character_maximum_length) {
        type += `(${col.character_maximum_length})`;
      } else if (col.numeric_precision) {
        type += `(${col.numeric_precision}${col.numeric_scale ? `,${col.numeric_scale}` : ''})`;
      }
      return type;
    }

    function groupBy(arr, key) {
      const groups = {};
      arr.forEach(item => {
        const k = item[key];
        if (!groups[k]) groups[k] = [];
        groups[k].push(item);
      });
      return Object.entries(groups);
    }

    async function loadTableData(schema, tableName, offset = 0, limit = 100) {
      const container = document.getElementById('dbDataContent');
      if (!container) return;

      container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading data...</div>';

      try {
        const res = await fetch(`/db/${currentDatabase}/tables/${encodeURIComponent(schema)}/${encodeURIComponent(tableName)}/data?limit=${limit}&offset=${offset}`, {
          headers: getDbAuthHeaders()
        });
        if (res.ok) {
          currentTableData = await res.json();
          currentTableData.schema = schema;
          currentTableData.tableName = tableName;
          renderTableData();
        } else {
          const err = await res.json().catch(() => ({}));
          container.innerHTML = `<div class="empty-state"><p>${err.error || 'Failed to load data'}</p></div>`;
        }
      } catch (e) {
        container.innerHTML = `<div class="empty-state"><p>Error: ${e.message}</p></div>`;
      }
    }

    function renderTableData() {
      const container = document.getElementById('dbDataContent');
      if (!container || !currentTableData) return;

      const { data, columns, total, limit, offset, schema, tableName } = currentTableData;
      const hasNext = offset + limit < total;
      const hasPrev = offset > 0;

      if (data.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding: 3rem;"><p>No data in this table</p></div>';
        return;
      }

      container.innerHTML = `
        <div class="db-data-container">
          <table class="db-data-table">
            <thead>
              <tr>
                ${columns.map(c => `<th>${c.name}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${data.map(row => `
                <tr>
                  ${columns.map(c => `<td>${formatCellValue(row[c.name])}</td>`).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div class="db-pagination">
          <div class="db-pagination-info">
            Showing ${offset + 1}-${Math.min(offset + limit, total)} of ${total.toLocaleString()} rows
          </div>
          <div class="db-pagination-buttons">
            <button onclick="loadTableData('${schema}', '${tableName}', ${Math.max(0, offset - limit)}, ${limit})" ${!hasPrev ? 'disabled' : ''}>Previous</button>
            <button onclick="loadTableData('${schema}', '${tableName}', ${offset + limit}, ${limit})" ${!hasNext ? 'disabled' : ''}>Next</button>
          </div>
        </div>
      `;
    }

    function formatCellValue(val) {
      if (val === null || val === undefined) return '<span class="db-null">NULL</span>';
      if (typeof val === 'object') return escapeHtml(JSON.stringify(val));
      return escapeHtml(String(val));
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function switchDbTab(tab) {
      currentDbTab = tab;

      // Update tab buttons
      document.querySelectorAll('.db-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });

      // Update panels
      document.querySelectorAll('.db-panel').forEach(p => {
        p.classList.toggle('active', p.dataset.panel === tab);
      });

      // Load data if switching to data tab and we have a table selected
      if (tab === 'data' && currentDbTable && !currentTableData) {
        loadTableData(currentDbTable.table_schema, currentDbTable.table_name);
      }
    }

    async function executeDbQuery() {
      const input = document.getElementById('dbQueryInput');
      const container = document.getElementById('dbQueryResult');
      if (!input || !container) return;

      const sql = input.value.trim();
      if (!sql) return;

      container.innerHTML = '<div class="loading"><div class="spinner"></div>Executing query...</div>';

      try {
        const res = await fetch(`/db/${currentDatabase}/query`, {
          method: 'POST',
          headers: getDbAuthHeaders(),
          body: JSON.stringify({ sql }),
        });

        const data = await res.json();

        if (!res.ok) {
          container.innerHTML = `<div class="response-panel active"><div class="response-status"><span class="code error">ERROR</span></div><pre class="response-body">${escapeHtml(data.error || 'Query failed')}</pre></div>`;
          return;
        }

        if (data.rows.length === 0) {
          container.innerHTML = '<div class="empty-state" style="padding: 2rem;"><p>Query returned no results</p></div>';
          return;
        }

        container.innerHTML = `
          <div class="db-data-container" style="max-height: 400px;">
            <table class="db-data-table">
              <thead>
                <tr>
                  ${data.fields.map(f => `<th>${f.name}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${data.rows.map(row => `
                  <tr>
                    ${data.fields.map(f => `<td>${formatCellValue(row[f.name])}</td>`).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <div class="db-pagination-info" style="padding: 0.75rem;">
            ${data.rowCount} row${data.rowCount !== 1 ? 's' : ''} returned
          </div>
        `;
      } catch (e) {
        container.innerHTML = `<div class="response-panel active"><div class="response-status"><span class="code error">ERROR</span></div><pre class="response-body">${escapeHtml(e.message)}</pre></div>`;
      }
    }

    function filterDbTables(filter) {
      tableSearchFilter = filter;
      renderDbTableList();
    }

    async function renderPostgresPanel() {
      const content = document.getElementById('contentArea');

      // Check if user is logged in and is super admin
      if (!currentUser?.token) {
        content.innerHTML = `
          <div class="panel-header">
            <h2>PostgreSQL Database</h2>
            <div class="meta">Port 5432</div>
          </div>
          <div class="empty-state">
            <div class="icon">üîê</div>
            <p>Super admin login required</p>
            <p style="margin-top: 0.5rem; font-size: 0.85rem;">
              Please log in as a super admin to access the database browser.
            </p>
          </div>
        `;
        return;
      }

      // Load available databases
      const hasAccess = await loadDatabases();
      if (!hasAccess || availableDatabases.length === 0) {
        content.innerHTML = `
          <div class="panel-header">
            <h2>PostgreSQL Database</h2>
            <div class="meta">Port 5432</div>
          </div>
          <div class="empty-state">
            <div class="icon">‚õî</div>
            <p>Access denied</p>
            <p style="margin-top: 0.5rem; font-size: 0.85rem;">
              Only super admins can access the database browser.
            </p>
          </div>
        `;
        return;
      }

      // Check connection first
      const isConnected = await checkDbConnection();

      content.innerHTML = `
        <div class="panel-header">
          <h2>PostgreSQL Database</h2>
          <div class="meta">Port 5432 ¬∑ Super Admin Access</div>
        </div>

        <div class="db-connection-status">
          <span class="status-dot ${isConnected ? 'healthy' : 'unhealthy'}"></span>
          <span>${isConnected ? 'Connected' : 'Not connected'}</span>
          <select id="dbDatabaseSelect" class="org-select" style="margin-left: auto;" onchange="switchDatabase(this.value)">
            ${availableDatabases.map(db => `<option value="${db}" ${db === currentDatabase ? 'selected' : ''}>${db}</option>`).join('')}
          </select>
        </div>

        ${isConnected ? `
          <div class="db-browser">
            <div class="db-sidebar">
              <div class="db-sidebar-header">
                <h4>Tables</h4>
                <input type="text" class="db-search" placeholder="Search tables..." oninput="filterDbTables(this.value)">
              </div>
              <div class="db-table-list" id="dbTableList">
                <div class="loading"><div class="spinner"></div>Loading...</div>
              </div>
            </div>

            <div class="db-main">
              <div class="db-tabs">
                <button class="db-tab active" data-tab="schema" onclick="switchDbTab('schema')">Schema</button>
                <button class="db-tab" data-tab="data" onclick="switchDbTab('data')">Data</button>
                <button class="db-tab" data-tab="query" onclick="switchDbTab('query')">Query</button>
              </div>

              <div class="db-content">
                <div class="db-panel active" data-panel="schema" id="dbSchemaPanel">
                  <div id="dbSchemaContent">
                    <div class="empty-state" style="padding: 3rem;">
                      <div class="icon">üìã</div>
                      <p>Select a table to view its schema</p>
                    </div>
                  </div>
                </div>

                <div class="db-panel" data-panel="data" id="dbDataPanel">
                  <div id="dbDataContent">
                    <div class="empty-state" style="padding: 3rem;">
                      <div class="icon">üìä</div>
                      <p>Select a table to browse its data</p>
                    </div>
                  </div>
                </div>

                <div class="db-panel" data-panel="query" id="dbQueryPanel">
                  <div class="db-query-editor">
                    <textarea id="dbQueryInput" class="db-query-input" placeholder="SELECT * FROM public.users LIMIT 10;"></textarea>
                    <div class="db-query-actions">
                      <button onclick="executeDbQuery()">Execute Query</button>
                      <span class="db-query-hint">Only SELECT queries are allowed</span>
                    </div>
                  </div>
                  <div class="db-query-result" id="dbQueryResult">
                    <div class="empty-state" style="padding: 2rem;">
                      <p>Enter a SELECT query and click Execute</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        ` : `
          <div class="empty-state">
            <div class="icon">üîå</div>
            <p>Could not connect to PostgreSQL database.</p>
            <p style="margin-top: 0.5rem; font-size: 0.85rem;">
              Make sure the database is running and accessible.
            </p>
          </div>
        `}
      `;

      if (isConnected) {
        await loadDbTables();
      }
    }

    async function executeRequest(serviceId, idx) {
      const service = SERVICES.find(s => s.id === serviceId);
      const endpoint = window.currentEndpoints[idx];
      const params = endpoint.parameters || [];

      const joinPaths = (a, b) => {
        const left = (a || '').replace(/\/+$/, '');
        const right = (b || '').replace(/^\/+/, '');
        if (!left) return `/${right}`;
        if (!right) return left || '/';
        return `${left}/${right}`;
      };

      // Build URL with path params
      let apiBase = serviceSpecs?.[serviceId]?.servers?.[0]?.url || '';
      apiBase = (apiBase || '').replace(/\/$/, '');
      if (apiBase && apiBase.startsWith('http')) {
        try {
          apiBase = new URL(apiBase).pathname.replace(/\/$/, '');
        } catch {}
      }
      if (apiBase && !apiBase.startsWith('/')) apiBase = `/${apiBase}`;

      const apiPath = joinPaths(apiBase || '', endpoint.path || '');
      let url = `/proxy/${service.port}${apiPath}`;

      params.filter(p => p.in === 'path').forEach(p => {
        const val = document.getElementById(`param-${idx}-${p.name}`)?.value;
        if (val) url = url.replace(`{${p.name}}`, encodeURIComponent(val));
      });

      // Add query params
      const queryParams = params.filter(p => p.in === 'query');
      if (queryParams.length > 0) {
        const qp = new URLSearchParams();
        queryParams.forEach(p => {
          const val = document.getElementById(`query-${idx}-${p.name}`)?.value;
          if (val) qp.append(p.name, val);
        });
        if (qp.toString()) url += `?${qp.toString()}`;
      }

      // Prepare request
      const options = {
        method: endpoint.method.toUpperCase(),
        headers: { 'Content-Type': 'application/json' }
      };

      // Add auth token if available
      if (currentUser?.token) {
        options.headers['Authorization'] = `Bearer ${currentUser.token}`;
      }

      // Add org scoping if available (many services are multi-tenant)
      if (currentOrgId) {
        options.headers['X-Org-Id'] = currentOrgId;
      }

      // Add body
      if (['post', 'put', 'patch'].includes(endpoint.method)) {
        const bodyEl = document.getElementById(`body-${idx}`);
        if (bodyEl?.value) {
          try {
            options.body = bodyEl.value;
          } catch {}
        }
      }

      // Execute
      const responsePanel = document.getElementById(`response-${idx}`);
      const codeEl = document.getElementById(`response-code-${idx}`);
      const timeEl = document.getElementById(`response-time-${idx}`);
      const bodyEl = document.getElementById(`response-body-${idx}`);

      responsePanel.classList.add('active');
      codeEl.textContent = '...';
      bodyEl.textContent = 'Loading...';

      const start = performance.now();
      try {
        const res = await fetch(url, options);
        const elapsed = Math.round(performance.now() - start);
        const data = await res.text();

        codeEl.textContent = res.status;
        codeEl.className = `code ${res.ok ? 'success' : 'error'}`;
        timeEl.textContent = `${elapsed}ms`;

        try {
          bodyEl.textContent = JSON.stringify(JSON.parse(data), null, 2);
        } catch {
          bodyEl.textContent = data;
        }
      } catch (err) {
        const elapsed = Math.round(performance.now() - start);
        codeEl.textContent = 'ERR';
        codeEl.className = 'code error';
        timeEl.textContent = `${elapsed}ms`;
        bodyEl.textContent = err.message;
      }
    }

    // ========================================
    // Quick Actions
    // ========================================

    async function quickAction(serviceId, method, path, title) {
      const service = SERVICES.find(s => s.id === serviceId);
      if (!service) {
        showQuickResults(title, 404, `Service "${serviceId}" not found`);
        return;
      }

      // Find the button and show loading state
      const buttons = document.querySelectorAll('.quick-action-btn');
      let clickedBtn = null;
      buttons.forEach(btn => {
        if (btn.textContent.includes(title.split(' ').slice(1).join(' '))) {
          clickedBtn = btn;
          btn.classList.add('loading');
        }
      });

      const url = `/proxy/${service.port}${path}`;

      const options = {
        method: method,
        headers: { 'Content-Type': 'application/json' }
      };

      // Add auth token if available
      if (currentUser?.token) {
        options.headers['Authorization'] = `Bearer ${currentUser.token}`;
      }

      // Add org scoping if available
      if (currentOrgId) {
        options.headers['X-Org-Id'] = currentOrgId;
      }

      try {
        const res = await fetch(url, options);
        const data = await res.text();

        let formatted;
        try {
          formatted = JSON.stringify(JSON.parse(data), null, 2);
        } catch {
          formatted = data;
        }

        showQuickResults(title, res.status, formatted, res.ok);
      } catch (err) {
        showQuickResults(title, 'ERR', err.message, false);
      } finally {
        if (clickedBtn) {
          clickedBtn.classList.remove('loading');
        }
      }
    }

    function showQuickResults(title, status, body, isSuccess = false) {
      const panel = document.getElementById('quickResultsPanel');
      const titleEl = document.getElementById('quickResultsTitle');
      const statusEl = document.getElementById('quickResultsStatus');
      const bodyEl = document.getElementById('quickResultsBody');

      titleEl.textContent = title;
      statusEl.textContent = status;
      statusEl.className = `status-badge ${isSuccess ? 'success' : 'error'}`;
      bodyEl.textContent = body;

      panel.classList.add('active');
    }

    function closeQuickResults() {
      document.getElementById('quickResultsPanel').classList.remove('active');
    }

    // Close quick results when clicking outside
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('quickResultsPanel');
      const isQuickActionBtn = e.target.closest('.quick-action-btn');
      const isPanel = e.target.closest('.quick-results-panel');

      if (panel.classList.contains('active') && !isQuickActionBtn && !isPanel) {
        closeQuickResults();
      }
    });
  </script>
</body>
</html>
